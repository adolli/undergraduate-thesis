\documentclass[a4paper,oneside,openany]{report}

\usepackage{CJK,CJKnumb}
\usepackage{indentfirst}
\usepackage{titlesec}
\usepackage{titletoc}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage[large]{caption2} % 图和表的标题模式使用large字号，12 磅

% 页边距设置
\geometry{
    left    = 2.5cm,      % 左边距
    right   = 2.0cm,
    top     = 2.5cm,
    bottom  = 2.0cm,
    headsep = 1.0cm,      % 页眉距离文档第一行文字的距离
    footskip= 0.5cm     % 最后一行文字的下边距离页脚的距离
}

% 中文支持起始
\begin{CJK*}{GBK}{song}


% 大纲编号等级一直到subsubsection
\setcounter{secnumdepth}{3}

% 中文字号定义
\newcommand{\chuhao}{\fontsize{42pt}{\baselineskip}\selectfont}
\newcommand{\xiaochuhao}{\fontsize{36pt}{\baselineskip}\selectfont}
\newcommand{\yihao}{\fontsize{28pt}{\baselineskip}\selectfont}
\newcommand{\erhao}{\fontsize{21pt}{\baselineskip}\selectfont}
\newcommand{\xiaoerhao}{\fontsize{18pt}{\baselineskip}\selectfont}
\newcommand{\sanhao}{\fontsize{15.75pt}{\baselineskip}\selectfont}
\newcommand{\sihao}{\fontsize{14pt}{\baselineskip}\selectfont}
\newcommand{\xiaosihao}{\fontsize{12pt}{\baselineskip}\selectfont}
\newcommand{\wuhao}{\fontsize{10.5pt}{\baselineskip}\selectfont}
\newcommand{\xiaowuhao}{\fontsize{9pt}{\baselineskip}\selectfont}
\newcommand{\liuhao}{\fontsize{7.875pt}{\baselineskip}\selectfont}
\newcommand{\qihao}{\fontsize{5.25pt}{\baselineskip}\selectfont}

% 文档各级标题定义
\titleformat{\chapter}[hang]{\normalfont\xiaoerhao\filcenter\CJKfamily{hei}}{第{\thechapter}章}{16pt}{}
\titleformat{\section}[hang]{\normalfont\sanhao\CJKfamily{hei}}{\thesection}{16pt}{}
\titleformat{\subsection}[hang]{\normalfont\sihao\CJKfamily{hei}}{\thesubsection}{16pt}{}
\titleformat{\subsubsection}[hang]{\normalfont\xiaosihao\CJKfamily{hei}}{\thesubsubsection}{16pt}{}

% 第一级标题上下边距设置，{左边距}{上边距}{下边距}[右边距]，因为居中，左右忽略，
% 我感觉在这里设置1行上下间距才是word里的0.5行
\titlespacing{\chapter}{0pt}{1ex}{1ex}
\titlespacing{\section}{0pt}{1ex}{1ex}
\titlespacing{\subsection}{0pt}{1ex}{1ex}
\titlespacing{\subsubsection}{0pt}{1ex}{1ex}

\titlecontents{chapter}[0em]
{\Large\CJKfamily{hei}\vspace{0.5em}}
{\thecontentslabel\quad}
{\vspace{2em}}
{\dotfill\contentspage}

\titlecontents{section}[2em]
{\large\CJKfamily{hei}\vspace{0.5em}}
{\thecontentslabel\quad}
{\vspace{2em}}
{\dotfill\contentspage}

\titlecontents{subsection}[4em]
{\large\CJKfamily{hei}\vspace{0.5em}}
{\thecontentslabel\quad}
{\vspace{2em}}
{\dotfill\contentspage}


\begin{document}

    % 设置默认字号，小4，20pt固定行距
    \setlength{\baselineskip}{20pt}
    \fontsize{12pt}{\baselineskip}\selectfont

    % 2字符首行缩进
    \setlength{\parindent}{2em}

    \pagenumbering{roman}
    \setcounter{page}{1}

    % 中文摘要
    \renewcommand{\abstractname}{\xiaoerhao \CJKfamily{hei} 摘~~要}
      \begin{abstract}

        新兴的移动支付技术有着轻松、迅速、安全的特点，以手机为主导的移动支付，在中国经历了多年的移动支付标准 （13.56MHz 与 2.4GHz 标准）争论后，在 2012 年终于有了定论，最终明确移动支付近场支付标准将采用 13.56MHz。

        移动支付的标准确定后，各大厂商便开始推进各类新技术发展，移动支付体系也逐渐步入正轨。NFC是移动支付的重要通信方式之一，在许多方面有无可比拟的优势，随着Android平台逐渐成熟，带有Android操作系统的智能手机也越来越多支持NFC技术，逐渐扫清了设备需求的障碍。

        本设计对NFC技术与Hybrid模式作了详细的说明，对系统总体设计方案进行了详细阐述，本设计主要构建了一个完整的基于NFC通信的第三方移动支付平台，为买家和卖家提供接入方式，使用NFC作为主要通讯方式为商品信息查询与结账身份认证。系统共由三大部分组成：移动客户端、受理终端、服务端。

        移动客户端采用Hybrid模式开发应用程序，使用HTML+CSS+javascript快速构建应用程序界面，使用Cordova插件技术实现NFC设备的访问与通信。本设计移动客户端NFC采用模拟卡模式，为满足更高层次通信需求，在现有NFC协议栈基础上进一步扩展传输层与应用层协议，并为应用层制定了安全套接层的加密约定以保障通信安全。

        收银台采用桌面计算机+NFC读卡器进行构建，使用扩展NFC协议栈对收银台应用进行部署。

        服务端采用VPS服务器搭建Web应用程序。

        最后，对整个移动支付的前景和发展趋势做出了展望，同时也对该系统未来的商用和实现做了进一步探讨和分析。

        {\sihao \CJKfamily{hei} 关键词：}~混合模式应用;~ 近场通信;~分组交换协议;~移动支付

      \end{abstract}

    % 英文摘要
    \renewcommand{\abstractname}{\xiaoerhao \CJKfamily{hei} Abstract}
      \begin{abstract}

        Write your abstract here.

        {\sihao \textbf{Keywords:} }~Hybrid App;~NFC;~Packet-Switch-Protocol;~Mobile payment

      \end{abstract}


    % 目录
    \renewcommand{\contentsname}{\CJKfamily{hei} 目~~录}
    \thispagestyle{empty}

    % 多页目录需要这样来隐藏页码
    \makeatletter
    \let \asas \ps@plain
    \let \ps@plain \ps@empty
    \makeatother
    \tableofcontents
    \makeatletter
    \let \ps@plain \asas
    \let\asas\relax
    \makeatother
    \thispagestyle{empty}


    % 表名与图名，将英文Table1.1换成中文表1.1
    \renewcommand{\captionlabeldelim}{~} % 表1.1或图1.1之后不加冒号，改为空格
    \renewcommand\figurename{\xiaosihao 图} % 图题和表题小四号
    \renewcommand\tablename{\xiaosihao 表}

    % 正文
    \chapter{绪论}

        % 从正文开始，页眉页脚默认样式
        \pagestyle{fancy}
            \fancyhf{}
            \fancyhead[CO,CE]{\wuhao 武汉理工大学毕业设计（论文）}
            \fancyfoot[CO,CE]{\wuhao \thepage}

        % 每一个章节的第一页默认没有页眉，这里强制加上去（其实没有页眉才好看吧。。。）
        \thispagestyle{fancy}

        % 第一页编号从正文开始
        \pagenumbering{arabic}
        \setcounter{page}{1}

        \section{课题背景}

            \subsection{互联网与电子支付}

                当支付遇到互联网，一场革命自然不可避免。成为现实的是传统的现金支付已经“退居二线”，各种在线支付方式成为人们日常消费的主要支付方式。银行推出的网银以及民营企业推出的各种各样的第三方支付平台大大方便了人们的生活，互联网支付终端也从桌面电脑扩展到移动终端和电视等多种形式的终端上，互联网支付变得无处不在。

                互联网支付并不完全等同于第三方支付，互联网支付与第三方支付只是拥有一定的交集，既不是等价关系也非从属关系。互联网支付除了包含第三方支付以外就还包括个人网络银行直接支付方式，而第三方支付的本质是通过第三方参与交易使得交易更加安全、方便，因此除了可以在互联网上进行外还可以通过其他渠道完成，如易付宝就已实现了离线支付，允许通过电话进行第三方支付。

                互联网电子支付按支付工具可分为以下若干类：
                \begin{enumerate}
                  \item \textbf{电子信用卡网络支付。} 信用卡是银行或其他财务机构签发给资信状况良好人士的一种特制卡片，是一种特殊的信用凭证。电子信用卡网络支付模式可以分为无安全措施的电子信用卡支付模式、借助第三方代理机构的电子信用卡支付模式、基于SSL协议机制的电子信用卡支付模式和基于SET协议机制的电子信用卡支付模式. 电子信用卡网络支付模式覆盖范围宽广，但对网络安全环境的要求较高。
                  \item \textbf{数字现金支付。} 电子现金是一种以数据形式流通的、能被客户和商家普遍接受的、通过Internet购买商品或服务时使用的货币。通过隐蔽签名技术的使用，允许数字现金的匿名，从而最大程度的保护了用户的隐私。无需银行银行中介的直接支付和转让使得这种支付模式十分经济。
                  \item \textbf{智能卡支付。} 智能卡是使用计算机集成电路芯片(即微型CPU和存储器RAM)用来存储用户的个人信息和电子货币信息，具有进行支付与结算等功能的消费卡。智能卡的网络支付方式依据在线或离线可分为两类，前者更多的是将智能卡当做拥有中央处理器的信用卡使用，而后者的典型代表则是日常使用的公交IC卡。
                  \item \textbf{虚拟货币支付。} 货币是社会生产发展的自然产品，是一种作为一般等价物的特殊商品，主要有三种职能：价值度量、价值储藏和交换媒介。因此从理论上来讲，除去传统的金本位，任何一种商品只要拥有作为一般等价物的资格都可以作为支付工具。虚拟货币就是应运而生的。但因为2009年6月文化部、商务部今日联合下发《关于网络游戏虚拟货币交易管理工作》的通知明确指出同一企业不能同时经营虚拟货币的发行与交易，并且虚拟货币不得支付购买实物。因此现在虚拟货币并不包括网游中的虚拟货币，主要指Q币、U币等。
                  \item \textbf{网银支付。} 网上银行又称网络银行、在线银行，是指银行利用Internet技术，通过Internet向客户提供开户、销户、查询、对帐、行内转帐、跨行转账、信贷、网上证券、投资理财等传统服务项目，使客户可以足不出户就能够安全便捷地管理活期和定期存款、支票、信用卡及个人投资等。可以说，网上银行是在Internet上的虚拟银行柜台。
                  \item \textbf{电子支票网络支付。} 电子支票是客户向收款人签发的，无条件的数字化支付指令。它可以通过因特网或无线接入设备来完成传统支票的所有功能。电子支票网络支付继承了纸质支票支付的优点的同时又降低了交易的费用成本，而因为使用公用关键字加密签名或个人身份证号码(PIN)代替手写签名等方法确保了交易的安全性，因此，现在电子支票网络支付得到了B2B电子商务的认可。
                  \item \textbf{电子汇票系统支付。} 电子汇票系统是依托网络和计算机技术，接收、登记、存储、转发电子汇票数据电文，提供与电子汇票货币给付、资金清算行为相关服务，并提供纸质汇票登记查询和汇票公开报价服务的综合性业务处理平台。该系统支持金融机构一点或多点接入。
                \end{enumerate}

                按支付终端来分类可分为：
                \begin{enumerate}
                  \item \textbf{移动支付。} 用户使用移动终端(通常是手机)对所消费的商品或服务进行账务支付的一种服务方式。目前移动支付业务主要是由移动运营商、移动应用服务提供商(MASP)和金融机构共同推出。手机支付分为近场支付和远程支付两种。近场支付是指将手机作为IC卡承载平台以及与POS机通信工具从而进行支付。远程支付仅仅把手机作为支付用的简单信息通道，通过Web、SMS、语音等方式进行支付，又可分为手机话费支付方式、指定绑定银行支付和银联快捷支付三种。除手机外使用平板电脑、上网本等其他移动终端也可以进行移动支付。
                  \item \textbf{电脑支付。} 电脑支付是最先兴起的互联网支付方式，从某种程度上来说，电脑支付的兴起推动了电子商务产业的发展。虽然近期随着移动支付的兴起，地位受到挑战，但在目前仍然占据着互联网支付中最多的份额。
                  \item \textbf{互联网电视支付。} 主要分为两种，一是将类似POS机的装置植入到遥控器当中；二是将银行卡的支付功能植入到数字电视机顶盒里面。
                \end{enumerate}

            \subsection{移动支付现状与发展趋势}

                移动支付在日本已发展较为成熟，众多平台及运营商联合推进，利用手机硬件优势，已有不少成功案例，移动支付覆盖面超过70\%。

                中国移动支付发展状况起步较早，发展较慢。中国也是移动支付出现较早的国家之一，1999年国内移动支付概念出现，但一直到2011年移动支付业务应用仍然较少，市场规模难以大幅扩大，主要原因有：

                \begin{enumerate}
                  \item 运营商、商业银行以及第三方支付等移动支付产业方尚未形成合力，在一定程度上存在相互掣肘的现象，影响了移动支付的发展。
                  \item 2010年之前国内的移动互联网覆盖基础稍弱，2010年之前移动互联网用户量不到2亿人，移动电子商务用户仅为0.77亿人，广大的国内用户没有养成使用移动网络进行支付的习惯，直接限制了远程支付的发展，也限制了用户使用近场支付的思维。
                  \item 2010年之前智能手机渗 透率过低，限制了远程支付和近场支付的应用推广。2010年国内智能手机出货量6200万部，渗透率仅为7\%。 远程支付除了手机短信等方式，更多的是使用 移动网络进行交易，智能终端的升级提高了手机网络支付的速度和使用感受；而装有NFC 近场支付模块和智能存储卡的手机基本为智能手机。
                \end{enumerate}

                而2011年之后，这些阻碍国内移动支付发展的因素正在逐渐消除：

                \begin{enumerate}
                  \item 2012年6月21日，中国移动与中国银联签署移动支付业务合作协议，标志着中国移动支付标准基本确定为13.56MHz标准。标准统一，阻碍移动支付发展的技术分歧去除。
                  \item 2011年之后移动互联网和移动电子商务的普及率提高，不仅为移动支付提供广阔的商用平台，更培养了用户网上支付的消费习惯，是移动支付市场爆发的重要催化剂。
                  \item 智能手机普及率提高，支持移动支付发展的硬件条件逐步具备。
                \end{enumerate}

                手机和银行卡是当今通信技术和金融服务结合的创新，是移动通信运营商新的业务增长点。目前，中国手机用户已超过固定电话用户数，达到两亿户以上，银行卡数量已超过5亿张。手机和银行卡与现代人们的生活越来越密切，手机将不再是简单的通信工具，手机用户可在任何时间，任何地点用手机办理消费、缴费和转帐等业务。移动支付正悄然兴起，逐步发展。

                美国、日本、韩国等国家最早推出了移动支付业务。其移动支付不仅可以付款，而且能从银行转帐，可以收进支出。韩国移动支付吸引了大量手机用户使用，为电信运营商、手机制造商、内容服务商等创造了巨大的商机。

                英国Vodafone公司于2003年7月再次推出了移动购物门户，该门户与零售商建立了虚拟购物中心。英国Parpal公司为用户提供了一种可通过E-mail 地址的移动支付业务，业务完成后，用户可以收到确认通知。

                意大利的摩托车旅行者可使用Fast pay的服务，通过移动电话支付停车费用、高速公路费用等。Fast pay 采用的Maglx 平台还提供给国际电子支付的Master card。

                相比于国外，中国移动支付的进展相对缓慢。广州是中国移动支付启动最早的地区之一，该地区的手机用户只要拥有支持移动支付功能的新版SIM 卡，并且在任何一家联网银行开户，就可以带着手机到各个商业网点去消费。如广州移动先后推出了“手机钱包”，“移动POS机”，“手机买可乐”，“手机投注彩票”等小额移动支付业务。

                中国联通在江苏无锡建成了联通首个移动小额支付试验系统，并在全国几个城市进行了试点工作。

                2003年年底，中国移动推出了手机小额购物服务。中国联通与中国银联合作，推出基于联通手机的移动支付业务，用户可在任何时间任何地点用手机进行消费等业务。联通的数据传输采用国家商密委批准使用的加密机进行加密，保证数据不被破解和修改。

                移动支付业务推出后，以其操作简单、方便快捷、不必到处去找ATM机等特点，颇受用户欢迎。

            \subsection{移动前端Hybrid开发模式}

                互联网公司通常选择Native App作为开发模式，在移动应用向企业普及的过程中，Native App的趋势传导给了企业。因此企业移动信息化通常先会尝试传统的Native App原生移动应用开发模式。但是企业很快发现，用Native App作为App开发模式的路子很难继续走下去。

                最主要的原因是Native App开发、更新、维护的周期太长，企业移动信息化大都处于尝试和摸索期，企业需要在短时间内快速推出不同的功能、产品来适应市场的需求和变化。但是Native App对于有专业开发团队的互联网公司而言推陈出新都是个难题，更不要说在企业中的应用。无论是企业自己开发还是外包都会面临时间成本、稳定性、体验不能满足要求的巨大压力。

                Hybrid App(混合模式移动应用)兼具“Native App良好用户交互体验的优势”和“Web App跨平台开发的优势”。下表列举了这几种模式的差异与各方面的对比。

                \begin{table}[htbp]
                  \centering  % 表居中
                  \setlength{\belowcaptionskip}{10pt} % 表标题与表间隔10pt
                  \caption{三种模式对比} % 表标题

                  \xiaosihao  % 表内容小四号字体
                  \begin{tabular}{lccc}
                    \toprule
                    % after \\: \hline or \cline{col1-col2} \cline{col3-col4} ...
                              & Web App    & Hybrid App & Native App \\
                    \midrule
                    开发成本  & 低         & 中         & 高 \\
                    维护更新  & 简单       & 简单       & 复杂 \\
                    体验      & 差         & 中         & 优 \\
                    Store或market认可 & 不认可 & 认可   & 认可 \\
                    安装      & 不需要     & 需要       & 需要 \\
                    跨平台    & 优         & 优         & 差 \\
                    \bottomrule
                  \end{tabular}
                \end{table}

                Hybrid App通常是基于第三方跨平台移动应用引擎框架进行开发，在国内开发者中比较知名的有Cordova、AppCan和Titanium。这些引擎框架一般使用HTML5 和Javascript作为编程语言，调用引擎封装的底层功能如照相机、传感器、通讯录、二维码等。HTML5和Javascript只是作为一种解析语言，真正调用的都是Native App 一样封装的底层功能，这是和Web App的最大区别和不同。因为使用了浏览器技术，所以Hybrid App通常具有跨平台的特性，并且开发成本和Web App 接近，开发效率也远高于Native App。

                Hybrid App开发已经成为企业移动开发的趋势，眼前还有很多企业在为移动信息化的途径和方向而苦恼。在投入、用户体验、维护成本等方面综合考虑，Hybrid App已经被众多企业所认可。甚至在企业移动信息化平台整体解决方案商提供的方案中，几乎全部都以Hybrid App为首选的移动应用开发模式。

                基于HTML5的 Web App 在移动端接受实用性检验后，开发者从热情转为观望。这时候 Hybrid App 作为现阶段 HTML 5 技术的落脚点正悄然兴起！Hybrid App （混合模式移动应用）兼具“Native App 良好用户交互体验的优势”和“Web App 跨平台开发的优势”。很多人不知道市场上一些主流移动应用都是基于 Hybrid App 的方式开发，比如国外有 Facebook、 国内有百度搜索等。

                Hybrid App 的兴起是现阶段移动互联网产业的一种偶然。移动互联网的热潮刮起后，众多公司前赴后继的进入。但是很快发现移动应用的开发人员太少，所以导致疯狂的人才争夺。市场机制下移动应用开发人才的待遇扶摇直上，最终变成众多企业无法负担养一个具备跨平台开发能力的专业移动应用开发团队。而 HTML5 的出现让 Web App 露出曙光，HTML5 开发移动应用的跨平台和廉价优势让众多想进入移动互联网领域的公司开始心动。可是当下基于 HTML5 的 Web App 更是雾里看花，在用户入口习惯、分发渠道和应用体验这三个核心问题没解决之前，Web App 也很难得以爆发。正是在这样是机缘巧合下，基于 HTML5 低成本跨平台开发优势又兼具 Native App 特质的 Hybrid App 技术杀入混战，并且很快吸引了众人的目光。大幅的降低了移动应用的开发成本，可以通过现有应用商店模式发行，在用户桌面形成独立入口等等这些，让 Hybrid App 成为解决移动应用开发困境不错的选择，也成为现阶段 Web App 的代言人。Hybrid App 像刺客一样，在 Native App 和 Web App 混战之时，偶然间的在移动应用开发领域占有了一席之地。

                Hybrid App 这个领域虽然还处于比较初期的阶段，但是已经有很多优秀的公司和技术团队在致力于跨平台开发移动应用中间件技术的研究，给了开发者众多选择。开发者可以根据实际的项目需求来选择中间件。Web App 虽被浏览器厂商和搜索引擎公司所推崇，但存在用户体验差、盈利模式不明确等现阶段无法解决的问题，或最终夭折。Hybrid App 正在被越来越多的公司和开发者所认同，势必会成为新世界的王。

                Hybrid App 是同时使用网页语言与程序语言开发，通过应用商店区分移动操作系统分发，用户需要安装使用的移动应用。总体特性更接近 Native App 但是和 Web App 区别较大。只是因为同时使用了网页语言编码，所以开发成本和难度比 Native App 要小很多。因此说，Hybrid App 兼具了Native App 的所有优势，也兼具了 Web App 使用 HTML5 跨平台开发低成本的优势。

                国内外Hybrid App的开发框架众多。下面对开发者比较关心的集中知名跨平台开发移动应用中间件进行列举和对比，以便选择最适合的移动应用中间件。
                \begin{itemize}
                  \item Cordova 是相对比较早进入公众视线的一种选择。但是，开发者简单的基于 Cordova 来开发移动应用肯定会发现结果和 Web App 比较差的用户体验类似。Cordova 主要使用HTML5来展现内容，使用Javascript来描述应用程序逻辑，但其拥有强大的插件体系，可以获得与Native App 相同的应用程序能力。
                  \item AppCan 在技术架构上和 Cordova 类似是 Web 主体型中间件，但是通过结合了一些原生交互效果能够达到 iOS、Android 平台都比较一致的用户体验。但是相比 Cordova 的开源，AppCan 相对封闭的路线显得过于谨慎。
                  \item Titanium 是一种基于翻译机制的跨平台中间件，能够开发出具有 Native 体验的移动应用，但是因为翻译机制的限制导致移动应用开发不能像真正的 HTML5 开发一样灵活。哪怕一个按钮也不能像普通 HTML 一样来编写，而必须按照 Titanium 约定的特定格式。
                \end{itemize}

                Hybrid模式具有先天的跨平台优势。所谓跨平台，就是让一个应用程序在多个不同的平台上不修改源代码可直接安装或运行。基于Hybrid模式的App 利用不同平台上的浏览器对网页兼容性的特性来实现跨平台地内容展示，即本质上并不是整个应用跨平台，而是所显示页面的内容、页面的样式以及页面中使用Javascript脚本是可以跨平台的。

                对于手机硬件或操作系统级别的资源的使用，是不跨平台的，如不同平台的手机使用摄像头的方式和权限都是不一样的。为了在不同平台上能以统一的方式使用平台级资源，则需要封装一个统一的访问接口，并在不同平台上实现这一接口与操作系统或平台的连接。Cordova框架很好地实现了不同平台资源的统一调用接口。Cordova以插件的形式向开发者提供了一系列访问平台级资源的接口，开发者直接调用Javascript脚本的对应方法，即可使用对应资源。

                因此，只要是不涉及本地代码而只使用HTML+CSS+Javascript方式开发的应用，都可以不修改任何代码，直接打包对应目标平台的应用程序安装包。

                插件是Hybrid App中一种应用广泛且成熟的模式，Cordova框架对插件支持最为灵活。Cordova 框架维护了页面中Javascript与本地代码（Native code）的交互，开发者调用插件的方法时，Cordova框架将此调用转发给对应预先编写好的本地代码，以实现本地资源的使用。

                虽然Cordova框架中已经封装好手机上大部分硬件以及平台级资源的插件，如短信、摄像头、联系人、震动、陀螺仪、GPS等，但仍然不能满足大多数应用的个性化需求。幸运的是Cordova具备自定义插件的特性，也正因为此，Cordova有了强大的生命力，开发者可以很轻易地实现使用Javascript进行手机的各个功能的使用。

                要自定义插件，就需要分别编写两个部分的代码，在Javascript 中定义插件调用接口，在本地代码中对接口进行实现，中间过程消息由Javascript发送到本地代码对应部分或本地代码响应Javascript则由Cordova管理，开发者无需操心。Cordova框架的插件模式结构如图\ref{fig:cordova-plugin} 所示。

                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=10cm]{img/cordova-plugin.png}\\
                  \caption{Cordova插件结构示意}
                  \label{fig:cordova-plugin}
                \end{figure}

        \section{课题的主要内容与目标}

            随着移动支付标准的确定，中国移动支付也将步入正轨，必将带来井喷式的快速发展。而 NFC 技术作为移动支付的手段之一，具有多方面的优势，为手机支付起到了推波助澜的效果。本文通过对 NFC 技术的介绍与Hybrid模式应用程序的开发，针对 NFC 技术的特点，为设备选型，制定更灵活的NFC 协议，方便设备软硬件层面的交互，设计并实现了基于第三方支付平台的移动支付系统。力求为还在发展中的 NFC 技术以及市场推广初现轮廓的移动支付应用提出有益建议，为基于 NFC 技术的移动支付打下坚实的基础。

            本文研究基本结构如下：

            第一部分，互联网电子支付与Hybrid模式概述，导出目前繁荣发展的互联网移动应用产业与新兴的NFC移动支付技术。

            第二部分，全面研究 NFC 技术的原理，以及 NFC 技术标准、工作原理。详细比较了NFC不同工作模式下的特点，点对点模式、读卡器模式、模拟卡模式，甄选出合适的NFC应用场景模式。与此同时，介绍与分析最近一两年发展成熟的Android移动应用平台与其最新的HCE技术，摆脱NFC支付需要第三方安全模块支持的麻烦。

            第三部分，通过分析现有NFC协议栈的功能特点，结合不同平台的NFC协议栈的优缺点，对NFC设备进行硬件选型，采用成本低应用于快速开发的基于Java 平台的第三方NFC 协议栈（nfc-tools），根据应用需求，对协议栈进行传输层与应用层扩展，深入研究NFC传输特点，开发不可靠信道上可靠传输的方法。

            第四部分，根据以上的基础，首先提出一个基于移动支付的自助购物方案，对其内容进行详细设计。这是一个使用手机摄像头进行条码扫描并使用手机的NFC设备与商场NFC终端设备进行交互以实现询价和支付功能的移动支付系统，其中还包括了看不见的后台服务端部分。然后是基于以上方案的具体实现，应用Hybrid模式构建移动客户端应用程序，使用虚拟机与嵌入式技术，构建带有NFC扩展协议栈的受理终端应用程序，应用Web 服务技术在VPS服务器上搭建移动支付系统后台服务端程序，以及数据库系统的建立。最后针对支付安全方面，讨论了非对称加密技术在此的应用。


        \section{课题的目的与意义}

            \subsection{移动支付}

                移动支付作为综合了支付类业务的各种功能的一项全新服务，将手机与信用卡两大高科技产品融合起来，演变成一种最新的支付工具，为用户提供安全、便捷、时尚的支付手段。移动支付的应用推广，是一个重大的实践问题。而NFC作为移动支付的手段之一，具有多方面的优势，为手机支付起到了推波助澜的效果。

                本文也正是依此为背景，将 NFC 技术引入到传统的移动支付中，同时考虑到移动支付的安全性问题，使用互联网通信中广泛使用的非对称加密技术，借助客户端-服务端公司密钥对的通信模式，很好解决了移动终端的安全性问题，该方式相比过去的使用SIM卡作为第三方安全模块也更佳便捷，对用户和硬件需求更低，也更利于市场推广和发展客户。

                另一方面，从目前市场状况来看，市场研究机构Gartner Inc.预测到2016年全球移动支付交易额将从今年的1720亿美元升至6000亿美元。随着移动支付业务的蛋糕越做越大，越来越多的公司和企业开始关注移动支付市场 。 美国电子交易协会（ETA）近日宣布成立移动支付委员会（Mobil ePayments Committee），美国十几家大型零售商近期可能会宣布联合开发移动支付网络的计划，该计划名为Merchant Customer Exchange（简称MCX）。国内众多第三方非金融支付机构、电信运营商也各自或联合推出了自己的移动支付产品。

            \subsection{Hybrid模式}

                Hybrid App、Web App、Native App，哪一种模式会成为App开发主流的争论由来已久。随着HTML5被过度热炒和实际开发中遇到的性能以及体验问题，Web App逐渐势弱。但是Native App开发难度大、成本高、周期长等问题突出，特别是App不断推陈出新，开发一个App的成本或许可以接受，但是维护一个Native App更新的成本则成了跨不过的悬崖。最终开发者和企业发现Hybrid App，这种既有跨平台开发周期短、成本低的基因，又能发挥Native App体验和性能的优势，Hybrid App混合式移动应用开发逐渐成为企业移动开发的首选。

                因为使用了浏览器技术，所以Hybrid App通常具有跨平台的特性，并且开发成本和Web App接近，开发效率也远高于Native App。很多企业采用Hybrid App技术开发移动应用，一方面是开发简单，另外一方面可以形成一种开发的标准。企业封装大量的Native Plugin(原生插件如支付功能插件)供Javascript调用，并且可以在今后的项目中尽可能的复用，从而大幅降低开发时间和成本。Hybrid App的标准化给企业移动应用开发、维护、更新都带来了极高的便捷性。
　　
                Hybrid App开发已经成为企业移动开发的趋势，眼前还有很多企业在为移动信息化的途径和方向而苦恼。在投入、用户体验、维护成本等方面综合考虑，Hybrid App已经被众多企业所认可。甚至在企业移动信息化平台整体解决方案商提供的方案中，几乎全部都以Hybrid App为首选的移动应用开发模式，包括IBM 的worklight、AppCan的MEAP和SAP的SUP平台。


    \chapter{移动支付及相关技术}

        \thispagestyle{fancy}


        \section{移动支付基础}

            \subsection{移动支付系统的组成}

                移动支付系统主要为移动客户端应用程序为核心展开，用户只需要使用移动客户端，选择或输入（多种输入方式）需要购买的商品，并使用唯一身份授权方式进行支付与交易。

                在商店进行购买商品时，移动客户端可以使用NFC或其他通信手段，通过与设置在商店内的廉价支付受理终端进行通信，完成选择与支付的请求，用户就不再需要传统的收银台了，只需要这样一款移动客户端应用程序就可以完成购物和支付了，不需要去看店员就可以心安理得地走出商店。

                支付信息将通过一种被称为“标记化”(Tokenization)的技术进行保护，使用第三方支付平台，交易与身份授权信息早已存在第三方支付平台数据库中，只等待用户的一个受权命令，这意味着真正的信用卡信息绝不会外泄。
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=8cm]{img/classic-airpay-composition.png}\\
                  \caption{典型的移动支付三大角色}
                  \label{fig:classic-airpay-composition}
                \end{figure}

            \subsection{移动支付的模式}

                移动支付（Mobile payment）包括远距离方式和近距离方式。远距离移动支付的主要技术实现方式有SMS、WAP、客户端（手机软件）和USSD；近距离移动支付的主要技术实现方式有红外和NFC。各种移动支付业务技术实现方式优劣势比较详见表\ref{tab:mobilepayment-comparation}。
                \newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}
                \begin{table}[htbp]
                  \centering  % 表居中
                  \setlength{\belowcaptionskip}{10pt} % 表标题与表间隔10pt
                  \caption{移动支付技术实现方式优劣势比较} % 表标题
                  \label{tab:mobilepayment-comparation}

                  \xiaosihao  % 表内容小四号字体
                  \begin{tabular}{lll}
                    \toprule
                    % after \\: \hline or \cline{col1-col2} \cline{col3-col4} ...
                    技术实现方式    & 优势 & 劣势 \\
                    \midrule
                    短息         & 业务实现简单，短信应用广 & 安全性差，操作繁琐，交互性差，响应时间不确定 \\
                    移动互联网       & 面向连接的浏览器方式，应用越来越广泛       & 响应慢，安全性相对较低 \\
                    客户端         & \tabincell{c}{可移植性强，网络资源消耗少与服务器负载低，界面友好，保密性高}  & \tabincell{c}{需要终端设备支持，不同平台的终端还要编译不同的应用程序版本} \\
                    USSD         & 交互界面友好，速度快，安全性高         & 需要终端和运营商支持 \\

                    红外 & 成本较低，普及性高   & 安全性低，距离有限，信号具有方向性 \\
                    NFC/蓝牙     & 安全性高，速度快，存储量大，交互性强       & 成本高，基础设施投入大，需要终端支持 \\
                    \bottomrule
                  \end{tabular}
                \end{table}

                在具体应用中，USSD和红外方式已经基本被其它方式取代了。在剩余的方式中，短信作为最简单的方式，是移动支付的早期实践方式，也是培育消费者体验的起点。这种方式适合用来提供移动银行业务，例如帐户查询、帐户变动通知、转账等服务，受到银行机构的认同和支持。随着移动互联网的应用普及，WAP/WEB方式也开始受到重视。特别是对银行机构或第三方电子支付服务商来说，这两种方式不依赖于运营商，银行或第三方支付服务商可以以此移动支付产业链掌控――或者说，通过这种方式，运营商和手机终端将被通道化。这种方式受到银行和第三方支付机构的大力支持。目前，包括工商银行、建设银行、支付宝等在内的多家机构都推出了基于WAP的支付服务。

                与上述方式相比，NFC方式非常需要终端的支持，并且一般是与手机SIM卡捆绑的。运营商在该种应用方式中，具有更大的掌控力，但这种与SIM卡捆绑的模式正在逐渐淡化，新的HCE技术出现将不再需要与运营商SIM卡捆绑。同时，该方式能够提供最便利的体验，因此受到运营商的大力支持。2008 年初，GSMA 设立了Pay-Buy-Mobile 计划，并发布基于SIM 卡的单线传输协议（SIM-Based Single Wireless Protocol）。目前已经有大约35 家国际主流运营商支持该计划。

                从发展趋势看，短信和客户端方式适合提供移动银行业务；WAP/WEB方式除了支持移动银行，还能够提供较好的远程（在线）购物体验；而NFC方式适合线下的商场、便利店、停车场等场合的支付应用。而移动支付产业链的各个参与方，基于不同的产业链掌控能力，对于业务方式发展策略也有所侧重。

                从用户体验来看，由于传统的互联网已经能够提供便捷的网银业务、在线购物服务，因此短信、WAP/WEB，甚至客户端方式将只是不便情形下的补充手段――特别是适合一些不便通过PC上网的学生或流动群体。而NFC方式由于具备很高的安全性和便利性，对年轻用户来说也很有时尚味道，因此被人为是未来移动支付的发展主流。

                从产业链环节上看，移动支付的主要参与者主要包括：消费者、平台提供商、银行、运营商和商户。其中，银行和运营商在其中具有较高的谈判能力。因此，可以按照这两者在产业链中的参与程度，划分移动支付的商业模式。总的来说，银行机构管理着广大用户的资金帐户，拥有完善的支付体系，在支付领域具有天然的用户信任。运营商则拥有完备的网络设施和先进的IT系统，通过定制终端，运营商可以将各种先进的移动应用提供给用户，使用户获得良好的移动化生活体验。因此，运营商在这方面具有较好的用户资源和营销渠道。

        \section{移动支付相关技术}

            \subsection{NFC技术}

                NFC（近场通信）是一种短距离的高频无线通信技术，允许电子设备之间进行非接触式点对点数据传输，在十厘米内交换数据。这个技术由非接触式射频识别（RFID）演变而来，由飞利浦半导体（现恩智浦半导体）、诺基亚和索尼共同研制开发，其基础是RFID及互连技术。近场通信是一种短距高频的无线电技术，在13.56MHz频率运行于20厘米距离内。其传输速度有106 kbps、212 kbps或者424 kbps 三种。目前近场通信已通过成为ISO/IEC IS 18092 国际标准、EMCA-340标准与ETSI TS 102 190标准。NFC采用主动和被动两种读取模式。

                最重要的NFC与操作模型相关的标准是NFCIP-1和NFCIP-2。NFCIP-1整合了两个RFID通讯协议：MIFARE 和FeliCa，扩充了新的通讯可能性和新的传输协议。NFCIP-2整合了NFC中RFID读取者的功能。这是NFC与大多数RFID设备相兼容的方式。RFID有严格的一个或多个被动组件（tags）和一个主动组件（reader），NFC打破这种观点。对于NFC设备而言，它可以与其它每一个组件通讯，包括标签和读者/写者。为了保证这种方式，NFC委员会定义了如下几种操作模型：点对点模型（Peer to Peer Mode），读者/写者模型（Reader/Writer Mode）和卡模拟模型（Card Emulation Mode）。系统结构在图\ref{fig:nfc-operation-modes}中给出，根据算法决定使用哪种模式，获取其它在NFCIP-2中定义范围内的NFC设备的信息。
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=12cm]{img/nfc-operation-modes.png}\\
                  \caption{NFC行为模式}
                  \label{fig:nfc-operation-modes}
                \end{figure}

                NFC的三种主要的行为模式如下，也称NFC的三种工作模式：
                \begin{itemize}
                  \item \textbf{P2P模式~~} 这个模式与其余的点对点通信差不多，可用于数据交换，只是传输距离较短，传输建立速度较快，传输速度也快，功耗低（与蓝牙相近）。将两个具备NFC 功能的设备链接，能实现数据点对点传输，如下载音乐、交换图片或者同步设备地址薄。因此通过NFC，多个设备如数位相机、PDA、 计算机和手机之间都可以交换资料或者服务。
                  \item \textbf{读卡器模式~~} 作为非接触读卡器使用，比如从海报或者展览信息电子标签上读取相关信息。能够读写各类NFC标准的卡。
                  \item \textbf{模拟卡模式~~} 卡模拟设备允许NFC设备与已知的RFID/NFC读卡器通讯。这些设备可以模拟一个或多个RFID智能卡。这种模式是有可能的使用现有的非接触式的基础设施，例如：支付或接入控制。智能卡的模拟可以用于应用或在称作安全元件（Secure Element）。安全元件像真实智能卡的设备，只是作为NFC 设备传输数据的接口。与读卡器模式结合，有可能实现与点对点模式相似的模式，而且这样更简单，因为不需要在点对点模式中的协议栈。有时甚至是在NFC模拟卡的设备没有供电的情况下，也能利用这种模式来通信。
                \end{itemize}


                \subsubsection{NFC点对点通信协议栈}

                    NFC协议栈一般指的是NFC在点对点模式下的协议栈，另外两种模式为兼容模式，其协议栈并不完整，一般只到逻辑链路层。
                    点对点模式能够在两台NFC设备之间通讯。开始通讯的设备称作发起者（Initiator），另外一个称作目标（Target）。点对点模式的协议栈与OSI Reference Model很相似，但是点对点模式只有4层，物理层（Physical），媒体接入控制层（Media Access Control），逻辑链路控制层（Logical Link Control）和应用层（Application）。物理层和应用层与OSI Reference Model 一样。MAC和LLC组成数据链路层。物理层和MAC层在NFCIP-1中定义，LLC 层是NFC 委员会定义的技术规范。如图\ref{fig:nfc-p2p-stack} 所示：
                    \begin{figure}[htbp]
                      \centering
                      \includegraphics[width=10cm]{img/nfc-p2p-stack.png}\\
                      \caption{NFC点对点模式协议栈}
                      \label{fig:nfc-p2p-stack}
                    \end{figure}

                    主动通讯模式和被动通讯模式在NFCIP-1中是有差别的。在主动通讯模式中，发起者和目标共享他们自己的RF域来实现通信，发起者开始NFCIP-1 通讯，目标在主动通信模式中使用自生RF域中的调制来响应一个发起者的命令。在被动通讯模式中，发起者产生RF域并开始通讯，目标在被动通讯模式使用负荷调制方案来响应发起者命令。这两种模式的主要区别是发起者和目标的能量消耗。在主动通信模式中产生RF域的能量是有发起者和目标共同承担的，而在被动的沟通模式中发起者必须供应产生域所需要的能量。

                    为了保证完整的通讯，NFCIP-1定义了如下协议流：在默认情况下，所有的设备应该保存在目标模式，不产生RF域。只有在响应应用和应用定义使用主动或被动通讯模式时设备才切换为发起者模式。发起者在产生RF域之前必须检查是否有其它活跃发送者保证没有其它通讯被干扰。如果没有其它RF域被检查到，发起者就开始通讯并通知目标使用主动或被动通讯模式和传输速度。在通讯结束，两个设备都要切回到目标模式并且停用他们的RF域。

                    在MAC层，只有发起者能开始数据传输，LLCP（逻辑链路控制协议）保证异步平衡模式（ABM）此外目标能够启动一个数据发送和错误恢复。LLCP 能够管理多个应用在同一时刻多点接入的多路技术。它提供了一个用最少的协议开销的连接传输协议,高层协议使用的流量控制机制。也提供面向连接的传输协议，它保证数据单元的逐一传送。LLCP不提供安全的数据传输模式。

                \subsubsection{Android平台的HCE技术}

                    HCE全名为Host-based Card Emulation，即基于宿主机器的卡模拟，Android平台的设备具有此特性，此技术改进了过去需要安全模块才能将设备模拟成卡的情形，通过应用程序的与操作系统的支持，Android平台的设备能直接模拟NFC标准的卡。其工作方式如图\ref{fig:host-based-card} 所示：
                    \begin{figure}[htbp]
                      \centering
                      \includegraphics[width=8cm]{img/host-based-card.png}\\
                      \caption{NFC卡模拟模式}
                      \label{fig:host-based-card}
                    \end{figure}

                    在NFC标准中提供了多种不同的协议，HCE技术能模拟这些不同协议对应的卡。Android4.4版本以后，许多非接触卡的应用已经存在，如非接触支付。特别地，Android4.4版本以上的设备均支持基于NFC委员会ISO-DEP标准（一个基于ISO/IEC 14443-4的标准）的卡模拟，其应用协议数据单元（APDU）为 ISO/IEC 7816-4 标准。

                    基于以上技术及特性，可利用Android操作系统的手机来模拟一张ISO-DEP标准的NFC卡。Android操作系统的HCE 服务能够非常方便地嵌入到应用中，HCE 服务一般处于后台运行，应用程序无需启动甚至不需要用户界面，在需要NFC 通信刷卡的场合这个特性的优势尤其突出，只需将手机背面往读卡器上一贴即可完成对应的通信。

                    在一个Android操作系统中可以存在多个HCE服务，这些HCE 服务与读卡器之间通过AID（应用程序ID）进行识别与选择，每个HCE 服务可设置一个或多个AID，读卡器发送带有指定AID的请求包来与HCE服务建立通信。举例来说，某一单一功能的读卡器发现有一Android设备靠近，则会尝试发送一个带有FF010203 的AID 的数据包，若这个Android设备的HCE服务注册了一个为FF010203的AID 则会对读卡器作出对应响应，否则不会作出响应。在这种机制保障下，读卡器能将数据发往正确的应用。

            \subsection{条码技术}

                条码是将线条与空白按照一定的编码规则组合起来的符号，用以代表一定的字母、数字等资料。在进行辨识的时候，是用条码阅读机扫描，得到一组反射光信号，此信号经光电转换後变为一组与线条、空白相对应的电子讯号，经解码後还原为相应的文数字，再传入电脑。条码辨识技术已相当成熟，其读取的错误率约为百万分之一，首读率大于98\%，是一种可靠性高、输入快速、准确性高、成本低、应用面广的资料自动收集技术。
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=6cm]{img/barcode.png}\\
                  \caption{一维或二维条码}
                  \label{fig:barcode}
                \end{figure}

                商品条码一般分为4个部分，按3-5-4-1分，第一部分代表国家，第二部分代表生产厂商，第三部分代表厂内商品代码，第四部分是效验码：以条形码 6936983800013 为例。此条形码分为4个部分，从左到右分别为：
                \begin{itemize}
                  \item 1-3位：共3位，对应该条码的693，是中国的国家代码之一。（690--695都是中国的代码，由国际上分配）；
                  \item 4-8位：共5位，对应该条码的69838，代表着生产厂商代码，由厂商申请，国家分配；
                  \item 9-12位：共4位，对应该条码的0001，代表着厂内商品代码，由厂商自行确定；
                  \item 第13位：共1位，对应该条码的3，是校验码，依据一定的算法，由前面12位数字计算而得到。
                \end{itemize}

                使用条码标记和存储信息还具有以下几大优势：
                \begin{itemize}
                  \item 输入速度快，与键盘输入相比，条码输入的速度是键盘输入的5倍。
                  \item 可靠性高，键盘输入数据出错率为三百分之一，利用光学字符识别技术出错率为万分之一，而采用条码技术误码率低于百万分之一。
                  \item 采集信息量大，利用传统的条形码一次可采集几十位字符的信息，二维条码更可以携带数千个字符的信息，可以包含图形或汉字，并有一定的自动纠错能力。
                  \item 灵活实用，条码标识既可以作为一种识别手段单独使用，也可以和有关识别设备组成一个系统实现自动化识别，还可以和其他控制设备联接起来实现自动化管理。
                  \item 条码标签易于制作，对设备和材料没有特殊要求，识别设备操作容易，不需要特殊培训，且设备也相对便宜。
                \end{itemize}

                条码的识别原理相对来说并不复杂，由于不同颜色的物体，其反射的可见光的波长不同，白色物体能反射各种波长的可见光，黑色物体则吸收各种波长的可见光，所以当条形码扫描器光源发出的光经光阑及凸透镜1后，照射到黑白相间的条形码上时，反射光经凸透镜2聚焦后，照射到光电转换器上，于是光电转换器接收到与白条和黑条相应的强弱不同的反射光信号，并转换成相应的电信号输出到放大整形电路，整形电路把模拟信号转化成数字电信号，再经译码接口电路译成数字字符信息。
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=8cm]{img/barcode-principle.png}\\
                  \caption{条码扫描识别原理图}
                  \label{fig:barcode-principle}
                \end{figure}

                二维码相对一维码携带信息量更大同时识别错误率也更低。因为二维码由相等大小黑白格子构成，边界定位区域除外，黑白格子分别代表数字量1 和0，这是和一维码最大差异之处，因此不需要使用根据反射光强度将模拟量转换成数字量，只用一阀值比较器即可判断对应比特位为1 还是0，因此误码率比一维码更低。

            \subsection{互联网技术}

                一九九三年美国的克林顿政府提出了“信息高速公路”计划，从而在这十多年间在全球范围内引发了一场信息风暴，信息技术几乎触及了生活的方方面面，毫不夸张的说没有了信息技术，现代文明的生活将无从谈起。作为信息技术中最重要的部分，互联网技术无疑是其发展的核心问题，他将原本孤立的信息统一到一张大网中，加快了信息的传递，缩短了人与人之间的距离。

                1969年，为了能在爆发核战争时保障通信联络，美国国防部高级研究计划署ARPA资助建立了世界上第一个分组交换试验网ARPANET，连接美国四个大学。ARPANET的建成和不断发展标志着计算机网络发展的新纪元。70年代末到80年代初，计算机网络蓬勃发展，各种各样的计算机网络应运而生，如MILNET、USENET、BITNET、CSNET等，在网络的规模和数量上都得到了很大的发展。一系列网络的建设，产生了不同网络之间互联的需求，并最终导致了TCP/IP协议的诞生。1980年，TCP/IP协议研制成功。1982年，ARPANET开始采用IP协议。1986年美国国家科学基金会NSF资助建成了基于TCP/IP技术的主干网NSFNET，连接美国的若干超级计算中心、主要大学和研究机构，世界上第一个互联网产生，迅速连接到世界各地。90年代，随着Web技术和相应的浏览器的出现，互联网的发展和应用出现了新的飞跃。1995年，NSFNET开始商业化运行。至此互联网开始迅猛的发展，互联网用户数量呈指数增长趋势，平均每半年翻一番。

                随着用户数量的增加和计算机技术的发展，互联网技术可谓日新月异。起初互联网的应用仅仅是一个一个独立的站点，也称为Web Site。HTML页面称为超文本链接标记语言 (HyperText Markup Language)是一种由简单的HTML命令组成的描述文本， HTML命令可以说明文字、图形、动画、声音和表格等等。页面与页面的交互是通过超链接完成的。对于内容的修改，只能通过修改静态HTML网页来完成。从某种意义上讲，这些网页只是电子形式的文本，在一处生成，内容固定，再发布到多处。在最初阶段，对于大学院校来说，这种应用已经足够了，大学可以通过简单地编辑HTML网页来发布其课程信息，科学家也可以将自己的论文发布在因特网上。但这已经比原先的纸张类期刊的传统信息交互媒介先进了许多。互联网应用从这里开始渐渐地显出了其独特的优势。然而在企业界，很少有人发现这一新的渠道能带来什么“商机”。实际上，以前公司主页显示的信息通常很少，无非是一些联系信息或者只是一些文档。不过没过多久，Web用户就开始有新的要求了，希望能得到更动态的网上体验。个人计算机成为企业不可或缺的资源，而且从个人宿舍到住家办公室开始出现越来越多的计算机，用户的期望也越来越高。互联网开始真正进入了动态时代。ASP，PHP，AJAX等技术如雨后春笋般被应用到互联网，但用户的需求会不断地在膨胀。

                目前，利用互联网技术，与运营商签约使用条款，可以方便快速地传输所需要的任何合法的内容，如资料文件、应用程序内容或应用程序本身（Hybrid App），移动支付充分利用了互联网技术，进行多方信息交换与通讯。

            \subsection{数据库技术}

                数据库技术是计算机数据管理技术。随着计算机技术的不断普及发展和应用，越来越多的数据库技术被不同规模，不同层次，不同领域所开发和采用，也愈来愈多的得到人们的重视和研究，得到愈来越多学者的关注。数据库技术主要类型有如下几种：关系数据库系统、并行数据库系统、分布式数据库系统、图形而象数据库系统、面向对象数据库系统、演绎数据库系统、时态数据库系统、空间数据库系统、工程数据库等。目前使用最多的为关系型数据库与分布式数据库系统。

                数据库作为计算机数据管理技术，具备数据结构化、低冗余度、高独立性、易扩充性，数据使用的非过程性及数据共享等特点；能够高效地管理，维护海量的信息。而这在未有这一技术之前，要实现其管理是不可想象的。

                E.Fcode关系理论的提出及其成为核心技术及概念的发展，使得从结构的角度看。如今数据库技术最基本的特征是关系型数据库的存在。

                从其数据库的产品来看，其高新技术的含量也越来越高，产品功能向全方位发展，其开放性更好，换代周期越来越短，并因其竞争激烈，价亦愈来越低。因而也就更加广泛的得到了应用。

            \subsection{信息安全技术}

                随着互联网的发展，信息的传输与获得随手可及，安全方面也显得越来越重要，信息安全主要为以下4个方面：
                \begin{enumerate}
                  \item 数据的完整性：它包括数据单元完整性和数据单位序列完整性。
                  \item 数据的可用性：就是要保障网络中数据无论在何时，无论经过何种处理，只要需要，信息必须是可用的。
                  \item 数据的保密性：即网络中的数据必须按照数据的拥有者的要求保证一定的秘密性。具有敏感性的秘密信息，只有得到拥有者的许可，其他人才能够获得该信息，网络系统必须能够防止信息的非授权访问或泄露。
                  \item 合法使用性：即网络中合法用户能够正常得到服务，正常使自己合法地访问资源和信息，而不至于因某种原因遭到拒绝或无条件的阻止。
                \end{enumerate}

                信息安全技术的内涵在不断地延伸，从最初的信息保密性发展到信息的完整性、可用性、可控性和不可否认性，进而又发展为“攻（攻击）、防（防范）、测（检测）、控（控制）、管（管理）、评（评估）”等多方面的基础理论和实施技术。信息网络常用的基础性安全技术包括以下几方面的内容。

                身份认证技术：用来确定用户或者设备身份的合法性，典型的手段有用户名口令、身份识别、PKI证书和生物认证等。 加解密技术：在传输过程或存储过程中进行信息数据的加解密，典型的加密体制可采用对称加密和非对称加密。 边界防护技术：防止外部网络用户以非法手段进入内部网络，访问内部资源，保护内部网络操作环境的特殊网络互连设备，典型的设备有防火墙和入侵检测设备。 访问控制技术：保证网络资源不被非法使用和访问。访问控制是网络安全防范和保护的主要核心策略，规定了主体对客体访问的限制，并在身份识别的基础上，根据身份对提出资源访问的请求加以权限控制。

                主机加固技术：操作系统或者数据库的实现会不可避免地出现某些漏洞，从而使信息网络系统遭受严重的威胁。主机加固技术对操作系统、数据库等进行漏洞加固和保护，提高系统的抗攻击能力。

                安全审计技术：包含日志审计和行为审计，通过日志审计协助管理员在受到攻击后察看网络日志，从而评估网络配置的合理性、安全策略的有效性，追溯分析安全攻击轨迹，并能为实时防御提供手段。通过对员工或用户的网络行为审计，确认行为的合规性，确保管理的安全。

                检测监控技术：对信息网络中的流量或应用内容进行二至七层的检测并适度监管和控制，避免网络流量的滥用、垃圾信息和有害信息的传播。


    \chapter{自定义NFC协议栈扩展}

        \thispagestyle{fancy}

        \section{NFC模拟卡模式}

            虽然在NFC的点对点模式协议栈已经完善，但是NFC点对点通信对设备与软件要求较高，目前并不是所有设备都能支持或兼容NFC的标准协议栈，而且NFC 点对点通信无论从硬件资源或软件开发成本来说都需要较高投入。为了在短期内弥补这一模式的不足，可采用更为简便的NFC模拟卡模式。

            NFC模拟卡模式虽然使用方便，但目前的NFC标准协议栈里只支持到LLC层（逻辑链路控制层），要能实际使用模拟卡模式，还需要进一步扩展协议栈。

            本设计用于模拟卡的设备模式基于Android HCE技术，利用Android提供的HCE服务，在Android平台上调用模拟卡相关API以及实现对应接口。

        \section{网络层扩展}

            本设计借助若干开源项目资源，对NFC模拟卡模式的协议栈进行扩展。使用一个已经封装至网络层的NFC协议栈（nfc-tools.tama），进一步向上封装传输层与应用层。

            nfc-tools是一个由grundid组织贡献的开源nfc开发工具包。nfc-tools封装了底层NFC协议栈与底层NFC SDK（软件开发工具），是一个面向桌面级与Android 操作系统手机NFC开发的有力工具。基于Java语言编写的nfc-tools封装了最新NFC协议，大大降低了NFC开发者的工作量，以及增加了NFC应用的跨平台特性，能够在桌面级操作系统上直接对基于智能卡接口（smartcardio）的NFC设备进行操作。

            nfc-tools具备libnfc、libllcp（一个底层NFC协议栈）全部功能，在此基础上，还进一步封装了网络层相关路由功能与特性，如多个NFC设备在同一NFC无线电场范围内互相通信保证数据正确传输到指定设备的特性。使用nfc-tools 进行NFC 应用开发时不需要关心底层逻辑的实现，只需维护好网络层以上通信对象与通信内容即可。

            \begin{figure}[htbp]
              \centering
              \includegraphics[width=5cm]{img/nfc-tools-stack.png}\\
              \caption{nfc-tools协议栈}
              \label{fig:nfc-tools-stack}
            \end{figure}

            尽管nfc-tools提供了网络层协议，能够进行多个设备之间的点对点传输，但传输仍然是不可靠的。NFC链路的无线电场有范围小，能量弱等特点，虽然建立过程非常快，但仍然容易受到干扰，一旦受到干扰，NFC链路就会断开，需要重新建立链路，正在传输的内容有可能会发生错误导致CRC 校验失败而导致内容丢失，甚至整一传输块内容丢弃。为了保障在不可靠链路上的可靠传输，本设计需要在nfc-tools现有协议栈之上，进一步封装传输层协议和应用层协议。

        \section{传输层扩展}

            \subsection{传输层分组交换协议}

                在NFC的通信中，因为环境因素或人为因素，在这么短的通信距离内，通信链路随时可能断开，如两个通信设备空间位置错位，或收到别的电磁信号干扰。传输层为了保障传输的可靠性，需要对传输的数据进行回应，以表示成功且正确接收数据。同时还需保障通信可断续性，即在上次通信中断后重新连接可继续上次的通信而不出现数据差错。为实现此模式，需要建立一系列通信格式与通信机制。为了简化该协议，本设计以主从通信方式为基础，实现主机- 从机的点对点传输层协议。在本协议中，为表达更为清楚，以下明确几点概念：
                \begin{description}
                  \item[主机] NFC通信中发起通信的一方。一旦通信范围内出现其他NFC设备，则主动尝试建立连接。若与从机处于可通信范围内，主机随时可以发起通信。
                  \item[从机] NFC通信中被动等待的一方。当收到主机发来的电磁波信号，可根据实际情况作出对应的回应。从机需要等待主机建立通信请求后才能与主机通信，不能主动建立连接。
                  \item[发送方] 传输层分组交换协议中对于某个正在发送或已经发送完成的分组来说，该分组来源于发送方，主机和从机的其中一方为发送方，另一方则为接收方，发送方与接收方的关系可能随时发送变化，发送方与接收方的概念仅为局部概念。
                  \item[接收方] 传输层分组交换协议中对于某个接收到的分组来说，带有该分组的一方为接收方。
                \end{description}

                由于网络层单次连续传输字节数有限，但网络层并未提供分块方法，因此传输层需要对要发送的数据进行分组，并为每一个分组加上头部，用于传输控制，分组的结构定义如所图\ref{fig:packet-structure} 示：
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=15cm]{img/packet-structure.png}\\
                  \caption{传输层协议分组结构}
                  \label{fig:packet-structure}
                \end{figure}

                每个分组由两部分组成，头部（head）和数据域（data），头部固定为4字节，数据域长度可变，可以为空，最多112字节，接收时，去掉头部的4 字节，剩下的部分即为数据域。头部中带有若干控制位及字段，其定义如下：
                \begin{description}
                  \item[CON] 请求连接标志。主机在网络层连接建立后，用于开启数据传输请求。
                  \item[EST] 连接建立标志。从机在收到主机的请求连接分组后，若接受主机的连接，则在回应主机的分组中将该位置1。表示主机与从机握手成功。
                  \item[ACK] 接收确认标志。接收方在接收到一个分组后，若已校验该分组无传输错误，则在下一个回应发送方的分组中将该位值1，发送方接收到的分组带有此标志位则可以将上一次发送的分组丢弃。
                  \item[FIN] 结束传输标志。主机不再希望继续交换分组时，将最后一个要发送的分组的该位置1，表示结束传输，若此时从机回应的分组同样带有此标志位时，则传输正式结束。
                  \item[TC] 数据发送完成标志。发送方将一个划分为多个分组的数据的最后一个分组发出前，在此分组的该标志位置1，表示某个待发数据发送完毕，接收方在接收到带有该标志位的分组时，将之前所有接收到的分组进行拼接，并向上层交付。
                  \item[EMP] 发送缓冲队列空标志。发送方若需要发送一个分组时，发送缓冲队列为空，则需要将该位置1。
                  \item[reserved] 保留字段，默认为0，为以后的扩展预留。
                  \item[checksum] CRC16校验码，分组发送前该字段为0，并算出整个分组的CRC16校验码后填写入该字段，接收到的分组将该字段取出，计算余下部分的CRC16校验码，用于判断传输是否出错。
                  \item[payload] 有效载荷。每个分组中实际带有的有效数据，长度可变，可以为空，最多112 字节。
                \end{description}

                相应地，传输层还应该能够对所划分的分组或接收到的分组进行拼接，以得到完整的数据。

            \subsection{异步发送缓冲队列}

                NFC通信中发送并非瞬间完成，NFC信道一般为单信道，新的待发数据需要等待前面的数据发送完成才可发送，因此需要一个发送缓冲队列，用于存储待发数据。

                如前所述网络层一次连续传输大小有限，需要对待传数据进行分组，一个待传输的数据在发送之前会被自动分组，并放入发送缓冲队列中，每一个待发数据在划分成若干分组后，第一个分组会标记为起始分组，用于区分多个待发数据在缓冲队列中的界限。数据交付网络层进行发送的时候计算其CRC 校验码并填写入分组对应字段。

                由于发送缓冲队列中的分组是连续且依次发送的，仅当前一分组成功被目标设备接收才进行下一分组的发送。如图\ref{fig:packet-send}所示。

                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=15cm]{img/packet-send.png}\\
                  \caption{分组发送示意}
                  \label{fig:packet-send}
                \end{figure}

            \subsection{异步接收事件监听器}

                传输层的数据接收采用监听器模式，不必阻塞式地询问是否有新的分组到达。网络层每当向传输层交付一个新的分组时，传输层会对此分组进行CRC 校验，若CRC校验正确，传输层会把该分组放入接收缓冲队列里，直到接收到一个带有数据发送完成标志的分组，然后将接收缓冲队列里的分组进行拼接，并将拼接后的数据向上层交付，即调用上层所注册接收事件监听器的接收事件方法，以通知上层进行进一步数据处理。

            \subsection{分组交换协议通信过程}

                基于主从模式下的点对点通信，主机具备发起通信的能力，而从机则不具备，因为主从设备往往空间位置关系都不确定，从机只能等待主机发起的通信建立的信号。为了实现主从设备之间的对等点对点通信，即不仅主机具备发送消息给从机的能力，从机也能向主机回应消息，一旦主机与从机建立连接，为了使得通信有序，因此需要定义如下通信与数据交换约定：
                \begin{itemize}
                  \item 主机首先发送第一个分组，作为握手信号
                  \item 从机每接收到一个分组便可回应一个分组，同理，主机在某分组发送后需等待从机的回应才可发送下一分组
                  \item 主机的发送缓队列为空时，仍然需要发送一个空的分组，并接收从机的回应，一直重复这个过程
                  \item 从机的发送缓冲队列为空时，在收到主机发来的分组后，仍需回应一个空的分组，一直重复这个过程
                \end{itemize}

                有了以上约定，主机与从机之间一旦建立连接后，便不断交换数据，任何一方有数据需要发送时，只需将数据分组后压入发送缓冲队列，即可发往对方。发送时将分组序列化为字节流，交给网络层进行发送。网络层接收到数据后，会自动将其反序列化为传输层分组，如果此时CRC 校验错误，则会往传输层交付一个空分组（无效分组），传输层会认为上一次发送失败，会重复上一次的操作，重新发送上一分组。分组交换协议详细流程如图\ref{fig:packet-switch-process} 所示：
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=5cm]{img/packet-switch-process.png}\\
                  \caption{分组交换协议流程}
                  \label{fig:packet-switch-process}
                \end{figure}

                % 解释并描述整个算法流程
                无论是主机还是从机，只要接收到一个分组，就要相应地回应一个分组。以下详细描述接分组交换协议的核心算法。
                \begin{enumerate}
                  \item 当接收到一个分组时，先判断是否带有ACK标志，如果带有，则表示上一个发送的分组已经成功被对方接收，此时可以将上一个发送的分组从发送缓冲队列中移除，即移除队头分组。如果收到的分组没有带有ACK标志，则表示对方没有成功接收上一次发送的分组，则这一次将取出上一次的分组重新发送。
                  \item 然后判断是否带有有效数据，即判断是否带有EMP标志，如果没有EMP标志，则将该分组压入接收缓冲队列，并将待发的分组设置ACK标志位，以告诉对方该分组正确接收。
                  \item 接着再判断是否带有TC标志，如果有TC标志，表示需要传输的一整段内容已经接收完毕，此时从接收缓冲队列里取出全部接收到的分组，并将其有效数据依次拼接成完整的字节流，交付上层。
                  \item 最后将待发分组序列化后交给网络层进行发送。
                \end{enumerate}

        \section{应用层扩展}

            \subsection{应用层文本传输协议}

                有了传输层的分组交换协议，使得所需要发送的数据不再受到大小的限制，任意大小的字节流，均可交由传输层进行可靠传输。但字节流对应用层来说并不能直观地表达信息，且需要为所要发送的对象实现序列化接口，参考目前使用较为广泛的文本传输协议或超文本传输协议（ HTTP），本设计基于NFC 传输层分组交换协议，进一步扩展应用层文本传输协议。

                使用文本作为信元进行传输，可以大大降低开发的过程中调试程序的工作量，因为信道里传输的符号均为可见的ASCII 码，发送或接收的信息可以直观地在屏幕或日志文件里显示出来，双方通信过程中是否出现差错或者复杂流程中传输内容是否正确一目了然。

                该层协议并不复杂，仅仅是将文本按照ASCII编码序列化后交给传输层进行分组传输，但可以利用XML、HTML、JSON等类型的文本，进行信息表示。其中，JSON字符串构成简单，仅6个保留符号，有效数据比例高，表达内容层次分明，故本设计采用JSON表示信息。

            \subsection{安全套接层}\label{sec:ssl}

                因为使用了明文的文本进行数据表示和传输，则会带来另一个问题――内容安全。尽管NFC只能在非常小的范围内进行通信，但因为是在开放的信道上，信息仍有被窃取的风险。因此需要在应用层与传输层之间设置一安全套接层进行数据加密。

                加密算法采用广泛使用的非对称RSA加密算法。RSA是一个既能用于数据加密也能用于数字签名的加密算法，公钥由其中一方向另一方交换，然后发送方在发送前对数据使用私钥进行加密，接收方在接收到数据后使用公钥对其解密，这样双方都能知道传输的真实内容，即使传输过程中数据被第三方窃取，但因为缺少公钥，所以不能得到正确的信息，从而保障了数据传输的安全。

                除了数据加密，还需要进行身份验证。使用非对称加密的公私密钥对的形式进行加密的好处就是可以用密钥进行身份验证，发送方使用自己的私钥对传输内容进行加密，接收方在公钥库中寻找对应公钥，进行解密，如果解密成功则可证明身份验证通过，否则为非法身份冒充。在客户机与服务器模式中，客户应该保存好自己的私钥，当服务器要发送数据给客户机时，使用客户机的公钥对数据进行加密，这样的数据只有客户机本身使用自己的私钥才能解密，即使数据被截获，也毫无价值。

            \subsection{应用层异步HTTP请求隧道协议}\label{sec:async-http-tunnel-protocol}

                在NFC通信中，如果需要借助其中一方向远程服务器传递信息，那么被借助一方则需要先解析请求方的传输内容，确定其HTTP请求的URL和请求数据等参数，当远程服务器将响应返回时再发送给请求方，这不仅增加了被借助方的运算负担，同时因为HTTP请求内容多种多样，会增加程序整体的复杂性。因此设计应用层异步HTTP请求隧道协议，用于改善请求方在无Internet 接入下需要发起HTTP请求的情形。

    \chapter{基于移动支付的自助购物方案设计与实现}

        \thispagestyle{fancy}

        \section{方案描述}

            使用手机的NFC功能代替使用刷信用卡或现金，这一做法可认为是移动支付。为实现移动支付，移动客户端软硬件、收银台软硬件以及支付系统后台服务端不可或缺。移动客户端为每一个付款方所持有，在其上需要NFC这一硬件支持，同时还需要安装支付软件。收银台是一个NFC通信设备与一台电脑，负责识别付款方与与收款方，并将交易信息与服务端进行交换。服务端负责维护商品、商家与客户的信息，包括交易记录与账户余额。

            本设计的移动支付系统由购买者独自完成整个购买流程，购买者使用移动客户端输入需要购买的商品，使用过收银台通过NFC通信接口进行自动询价，最后再次使用收银台通过NFC 通信接口进行身份验证和支付，即可完整整个购买流程，收银台将不再需要人工进行商品识别和人工金额支付，大大降低运营成本。

            % 这里可以插入一个整个系统的示意图
            \begin{figure}[htbp]
              \centering
              \includegraphics[width=15cm]{img/query-merchandise.png}\\
              \caption{商品询价模式示意图}
              \label{fig:query-merchandise}
            \end{figure}

        \section{移动客户端}

            移动客户端有两个主要功能，商品条形码识别与使用NFC 与收银台通信。以下详细说明两大功能的实现与客户端用户界面的设计。

            客户端App采用Hybrid模式构建，Hybrid模式应用可跨平台，但插件部分需要分别对各个平台进行实现，本设计中插件仅在Android平台下实现，其余平台可进行移植。

            Hybrid App界面可从Internet加载，也可从本地资源中加载。从本地资源中加载时具有与Native App相当的加载速度与显示效果，但不能像从Internet加载方式灵活。考虑到节省用户的网络流量，客户端App的资源文件均保存在本地，包括页面、样式表、脚本等，相当于离线浏览。当内容需要更新时，可通过NFC网络对资源文件进行更新，如更新页面内容。

            \subsection{插件}

                为了使用平台资源，必须实现条码扫描、NFC等插件。通过继承CordovaPlugin抽象类并实现execute方法并在res/xml/config.xml文件中注册该插件即可完成一个自定义插件。同时还需在Javascript中编写插件的原型，以让Cordova知道插件在前端与本地实现中的关系。

                在插件的execute方法中，一般是接收来自Javascript插件原型发来的action，根据不同的action执行不同的操作，最后将要返回Javascript的信息写入参数callbackContext中，一般是JSON字符串，在前端就可以顺利获取结果了。

            \subsection{条形码扫描插件}

                条形码扫描插件为Cordova插件，HTML页面中通过调用扫描商品的接口，应用程序则会打开条形码扫描界面，一次可扫多个条码，扫描结束后，条形码扫描插件会将扫描结果返回给HTML页面，HTML页面可对这些条码进行存储或者显示。

                % 条形码扫描模块zxing介绍
                条形码扫描核心程序采用Google开源项目zxing构建，zxing是一个基于Java实现的集合了多种类型条码编码与解码器的类库，本设计引用了zxing 的条码识别与解析库，以此库为处理核心，构建了扫描界面，模拟条形码扫描枪的工作。

                在自建的扫描界面中，调用摄像头硬件，将摄像头所拍摄预览界面显示在扫描界面中，在扫面界面中央放置一矩形框，标示条形码识别范围。通过周期性控制摄像头对焦矩形框中心位置并捕捉图像，将图像送往zxing的条码解析器，判断是否能解析，如果画面中有清晰的条码，则zxing解析器会以字节数组的形式返回解析后的信息。得到条码的信息后，将其显示在扫面界面下方的预览区，用户可根据预览结果判断是否为所需要的条码，若为误操作结果，可以点击预览区的重扫按钮，将这次的扫描结果去掉。

                每次扫面成功后，会将扫面的结果保存在一个列表中，所以在扫描界面中可进行连续多个条码的扫面和识别，不需要每次都启动扫面界面。

                扫面界面可在应用程序任意环境中通过Activity.startActivityForResult方法启动扫描界面，当扫描结束时（点击扫描界面的右上角完成按钮可结束扫描界面），扫面的结果会被返回到启动扫面界面的换进中，在此环境通过覆写onActivityResult方法，从intent参数中可取出扫描结果列表。

            \subsection{用户现金卡模块AirCard}

                本设计移动客户端其一功能为代替信用卡或现金进行支付，为使客户端易于理解，客户端内设有用户现金卡模块（AirCard）。

                AirCard保存了个人账户信息，在进行商品结算时，收银台通过识别个人账户信息并向服务端发出交易请求。

            \subsection{HostApduService}

                HostApduService用于实现Android HCE服务，本设计使用NFC的模拟卡模式，将移动客户端模拟为NFC 卡。模拟卡需要设置一个AID，该AID 还需与收银台协商统一，在收银台与移动客户端通信时，通过此AID进行应用通道识别。

                客户端App继承了HostApduService，在派生类中需要实现processCommandApdu方法，该方法为模拟卡模式中接收与处理读卡器发来的数据包，每次从参数接收的数据包为原始字节数组的形式，相当于网络层的数据包的内容。一般在连接是，第一个收到的数据包会带有AID数据，如果设置了多个AID，则可以根据不同AID进行选择不同的处理方法。本客户端App只设置了一个AID，每次收到的数据包，网络层连接包除外，均直接转发给扩展协议栈分组交换协议进行处理，将分组交换协议处理后的应答数据包序列化后在此方法中返回，Android设备会自动将其发给读卡器。

            \subsection{界面}

                客户端App的界面与Web页面开发类似，使用HTML编写内容，CSS定义样式。本设计使用jQuery Mobile框架进行页面构建，jQuery Mobile 是 jQuery 在手机上和平板设备上的版本。jQuery Mobile 不仅会给主流移动平台带来jQuery核心库，而且会发布一个完整统一的jQuery移动UI框架。支持全球主流的移动平台。使用jQuery Mobile框架，可以方便快速构建适用于移动客户端的Web界面。

                jQuery Mobile页面结构由多个page组成，对于每一个page来说分成head、content和foot三部分，就像目前大多数移动应用程序的UI一样，head主要显示界面标题与左上角返回按钮等，content为页面主体，可随意定义内容。jQuery Mobile还提供了非常丰富的控件，按钮、表格、复选框、文本框、控制条等，可以直接在HTML文件中调用这些控件而不需要为其编写Javascript脚本或CSS样式。界面设计可见图\ref{fig:shopping-list}。
                
            \subsection{寻价模块与购物清单界面}

                当商品通过摄像头将其条形码扫描识别后，每个商品会在购物清单界面中列出，在此界面可以更改购买的数量或者删除某商品项目。这时可将手机背面靠近收银台的NFC通信区域，移动客户端应用程序会自动与NFC设备交互，进行询价操作。收银台在这里是个中间媒介，收银台将询价的HTTP 请求转发到服务端，服务端从数据库中查询相应内容后将数据返回，收银台再将商品数据回应给移动客户端，此时客户端界面上就可以显示商品的详细信息了。利用节\ref{sec:async-http-tunnel-protocol}所述协议，可以很好地实现移动客户端借助NFC中间设备进行HTTP请求，对于移动客户端来说，相当于直接进行了服务端的访问，中间过程是透明的。询价前后的界面显示如图\ref{fig:shopping-list} 所示。
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=10cm]{img/shopping-list.png}\\
                  \caption{购物清单~询价前（左）~询价后（右）}
                  \label{fig:shopping-list}
                \end{figure}

            \subsection{结账确认界面}

                当在购物清单中确认好所要购买的商品和数量后，点击确认购买可以转到结账确认界面，在此显示了支付总金额和个人账户认证等信息，需要填写好个人账户号和密码。此时并没有完成结算，需要再次将手机背面靠近收银台NFC通信区域，同询价类似，移动客户端会借助收银台向服务端发送HTTP 请求，结账过程会自动执行。如果结账成功，界面会提示成功的消息同时显示账户余额，如果结账失败，界面会提示余额不足或用户认证失败等消息。结账界面如图\ref{fig:shopping-comfirm}所示
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=10cm]{img/shopping-comfirm.png}\\
                  \caption{结账确认界面}
                  \label{fig:shopping-comfirm}
                \end{figure}

        \section{受理终端}

            收银台一般在商店或者超市里，为移动客户端提供询价和结算的NFC通信接口。收银台的功能比较简单，主要为移动客户端转发HTTP请求，建立异步HTTP 隧道协议，对移动客户端进行身份验证。

            受理终端为一Java应用程序，通过控制连接在受理终端计算机上的NFC读卡器，进行NFC通信与相关数据处理，将来自NFC协议栈中的HTTP请求通过Internet进行传输，得到服务器的反馈结果后再通过NFC读卡器传输到移动客户端上。

            \subsection{NFC通信设备}

                受理终端使用ACR122U作为NFC通信设备，ACR122U采用PN532作为NFC通信芯片，通过USB总线集成芯片将通信接口转换成USB，方便与计算机连接。PN532是一个高度集成的非接触读写芯片，它包含80C51微控制器内核，这个80C51内核用户不能对其编程，它用于内置NFC的底层通信协议栈，同时还集成了13.56MHz下的各种主动/被动式非接触通信方法和协议。PN532以下若干重要特性，也是本系统所需求的。
                \begin{itemize}
                  \item 高度集成的模拟电路，解调和译码响应。
                  \item 输出缓冲驱动器通过最少量的外部无源器件连接天线。
                  \item 集成了RF场检测器。
                  \item 集成了数据模式检测器。
                  \item 支持ISO/IEC 14443A / MIFARE。
                  \item 只在读写器模式中支持ISO/IEC 14443B。
                  \item 在读写器模式中，支持Mifare Classic加密，可支持212 kbit/s和424 kbit/s两种更高数据传输速率。
                  \item FeliCa模式下，支持106kbit/s 、212kbit/s和424kbit/s的通信波特率。
                  \item 集成了NFCIP-1的RF接口，传输速率高达424kbit/s。
                \end{itemize}
                
                受理终端的NFC 角色为读卡器，与移动客户端配合，实现点对点通信。

                \subsubsection{ISO-DEP读卡器会话建立}

                    由于移动客户端所模拟卡为ISO-DEP标准卡，故需要将收银台NFC设备配置为ISO-DEP读卡器。在nfc-tools中可使用AbstractTamaCommunicator 配置为ISO-DEP模式读卡器， AbstractTamaCommunicator 是个带有 NFCIPCommunicator 接口的抽象类，实际使用时需要实现用户交交换数据的抽象方法。网络层交换数据方法，网络层发送连接请求数据包，向NFC 模拟卡设备发起连接，再发送带有相应AID 的应用程序协议数据单元以告诉移动客户端应用通道选择。至此收银台与移动客户端会话建立完成，传输层可在分组交换协议之上进行数据交换。

            \subsection{询价/支付服务}

               受理终端主要负责将移动客户端HTTP请求进行转发，以实现询价和支付服务。收银台NFC设备同样也使用NFC扩展协议――传输层分组交换协议，受理终端在与移动客户端建立连接后，开始监听分组接收，一旦完整数据接收完毕，会立即交付应用层，应用层对数据进行判断，若是一个HTTP 请求，则会将HTTP 请求转发给服务端，并监听服务端的响应，一旦服务端响应，其响应内容会原样转发给传输层，由传输层进行分组并发送给移动客户端。整个过程的持续时间受受理终端到服务端的网络延迟影响。

               由于受理终端到服务端的信道不是阻塞型的，可连续发送多个HTTP请求，每个HTTP请求由应用层对其设置不同标识，因此不会发生回应错乱，这样可大大提高信道利用率。整个询价或支付过程一般不超过1秒。

               受理终端实际上不具备交易数据更新等能力，实际上都是将请求发往服务端进行处理，受理终端在此只是一个中间媒介。

        \section{服务端}

            服务端对外主要表现为一个第三方支付平台，由商家提供各类商品信息，用户使用该平台进行商品的选择和支付。服务端需对外要维护一些列Web服务接口，内部要维护各类信息的数据存储。

            对外服务包括商品信息查询、用户信息查询、商品注册、用户注册和商品交易等，商品信息查询提供了使用商品编码向服务端查询商品信息的服务，如最基本的询价；用户信息查询为商家或购买者提供查询账户余额与交易记录的服务；商品注册为商家提供新商品的信息录入服务；用户注册为欲使用本系统的新商家或购买者提供的信息录入服务；商品交易为交易双方资金担保与转移的服务。

            \subsection{服务端架构}

                根据以上功能，需要服务端提供相应的软件支持，服务端架构主要分为以下4大方面。

                \subsubsection{对外服务接口}

                    对外服务接口是提供一个Internet环境中可访问的一个服务器端口，本设计使用开源服务端软件nginx。nginx是一个轻量级高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP 代理服务器。具有出色的静态文件解析与负载均衡能力，与Apache服务器相比，nginx具有配置简便、占用内存更小、运行速度更快等优势，适合小型业务的快速开发。

                    本设计使用nginx将动态的HTTP请求转发给Web服务器网关接口，所有的业务逻辑相关的请求由Web服务器网关接口实现，nginx仅作为一个统一的访问入口。
                    
                    nginx使用默认配置，分配并监听服务器端口8082，设置随服务器启动自动启动，这样不必每次都手动开启nginx。

                \subsubsection{Web服务器网关接口}

                    Web服务器网关接口采用开源软件uWSGI作为服务器的Web服务提供者，uWSGI集合了众多Web 服务提供者的优点，能与nginx很好地配合，通过部署服务端脚本，进行动态请求的处理。

                    一个服务器中可以存在多个uWSGI服务实例，根据本设计需求，一个uWSGI服务实例即可满足，在服务器上配置好uWSGI后，会自动加载服务端脚本，一旦收到nginx发来的动态请求，就会执行相应的脚本进行处理与数据返回。

                \subsubsection{服务端脚本}

                    真正处理整个移动支付业务逻辑的地方在服务端脚本中，服务端脚本需要负责处理所有相关的HTTP请求，如询价、支付等。与uWSGI 相配合，服务端脚本语言采用python，python在服务端应用开发中，具有众多出色的开源软件包可使用，其软件资源已经十分成熟。

                    本设计使用开源软件包Bottle进行服务端脚本构建。使用Bottle可以非常简洁快速地构建服务端页面与HTTP 请求的处理。
                    
                    使用Bottle的路由特性可以将客户端发来的请求转发到对应处理过程进行处理，如询价请求则从request.POST对象中取出请求的数据，通过MySQL的python连接器连接数据库，进行查询商品信息，再直接将要返回的数据以python object的形式返回即可。

            \subsection{数据库设计}

                % 本节内容描述数据库存储与关系结构
                用户信息、商品信息、交易记录等需要进行持久化存储，对于服务端环境来说，使用数据库存储最为合适。本设计采用开源的数据库管理系统MySQL对数据进行存储与管理。是一种开放源代码的关系型数据库管理系统（RDBMS），MySQL数据库系统使用最常用的数据库管理语言――结构化查询语言（SQL）进行数据库管理。MySQL因为其速度、可靠性和适应性而备受关注。

                关系型数据库已经非常成熟，它使用系统核心提供的多线程机制提供完全的多线程运行模式，提供了面向C、C++、Eiffel、Java、Perl、PHP、Python以及Tcl等编程语言的编程接口（APIs），且MySQL 也提供了丰富的数据库连接组件，在python 脚本中可以非常方便地与数据库连接，支持多种字段类型并且提供了完整的操作符支持查询中的SELECT和WHERE操作。故采用MySQL作为首选数据库管理系统。

                本设计移动支付系统中需要存储商品信息（包括商品的价格、生产商等）、用户信息（包括购买者与销售者的身份基本信息与账户信息）、交易信息（包括交易快照与资金转移记录等）、日志记录等。这些信息按照关系数据库理论的第三范式原则进行划分，存储在若干表中，一般情况下，通过python 脚本使用SQL语言对数据库进行操作。

        \section{支付安全}

            涉及到资金的业务中，安全问题是必须关心的，本设计移动支付系统需要保障交易和个人信息安全。如节\ref{sec:ssl}所述，非对称加密能很好地实现这一点。用户使用移动支付系统的服务端公钥对个人信息进行加密传输，只有服务端能进行解密，个人身份认证采用个人私钥对个人标识进行加密，由服务器使用个人公钥对数据进行解密则可以验证身份，而他人截获个人身份标识数据毫无价值，个人身份标识如用户名一般情况下是公开的。

            在NFC扩展协议栈中，由安全套接层实现以上加密过程，只要是应用层中传输的数据，均可以保证安全。

            \subsection{基于非对称加密的身份认证}
            
                本设计在安全套接层中采用RSA 非对称加密算法，RSA算法一般由发送方生成公私密钥对，公钥可公开，可被任何人获取，发送方将要发送的数据和签名使用私钥加密，并发给接收方，接收方用公钥解密后即可获取原数据内容。
                \begin{figure}[htbp]
                  \centering
                  \includegraphics[width=10cm]{img/rsa.png}\\
                  \caption{非对称加密与传输过程}
                  \label{fig:rsa}
                \end{figure}
                
                这种情况下发送方发送的数据仍然是可以被第三方所解密的，因为使用了私钥加密，这种单方面加密方式一般是用在身份认证，例如服务器对个人登陆时的身份认证，如果通信内容只能被双方所知道，则还需要在发送方发送数据前使用接收方公钥进行加密，这样发出的数据只有接收方能使用接收方的私钥解密，经过这样两层加密过程，双方既完成了身份验证，也实现了数据在传输过程中的加密。

            \subsection{数据签名}
            
                虽然传输层已经对数据进行了有效的可靠传输与容错保障，但对应用层上的数据篡改无能为力，为保证数据在长距离或大延迟环境中的内容完整性，还需要对数据内容进行校验。本设计采用广泛使用的MD5校验法，MD5为计算机安全领域广泛使用的一种散列函数，用以提供消息的完整性保护。任意长度的数据，算出的MD5值长度都是固定的，从原数据计算出MD5值很容易，对原数据进行任何改动，哪怕只修改1个字节，所得到的MD5值都有很大区别，已知原数据和其MD5值，想找到一个具有相同MD5值的数据（即伪造数据）是非常困难的，因此MD5算法能有效保障信息传输的完整性。
                
                通过对要传输的数据使用MD5算法，得到的是一个字符串，这个字符串可看作是这个要传输数据的指纹，发送方在发送数据时将计算出的指纹附加在最后，接收方接收到数据后，对接收到的数据重新执行一个MD5算法，得到的指纹与接收到的指纹进行对比，若相同则表示数据传输无误。

        \section{方案实验}

            本节将演示整个系统的工作流程。通过使用移动客户端，对商品条码进行扫描，再使用受理终端查询商品价格，修改好购买数量，最后使用收银台确认支付。整个操作分为以下若干步骤。

            \begin{enumerate}
              \item 打开移动客户端，点击继续添加商品，此时会自动切换到条形码扫描界面。将屏幕中间红线对准条形码并与条形码垂直，等待下方出现条形码扫描结果，移开商品，准备扫描下一件。如果当前某个条码误扫，可点击重扫按钮取消这个扫描结果。商品扫描界面如图\ref{fig:shopping-scan}所示。
                  % 此处配图条形码扫描界面
                  \begin{figure}[htbp]
                    \centering
                    \includegraphics[width=6cm]{img/shopping-scan.png}\\
                    \caption{条形码扫描界面}
                    \label{fig:shopping-scan}
                  \end{figure}

              \item 扫描商品这个过程可重复进行多次，扫描完成后会自动返回购物清单界面，在此界面里设置好需要购买的商品的数量，本设计的示例中随机设置若干商品的数量。在刚扫描完条码时，购物清单界面只能显示商品条码，若要查询商品名称与价格，则需将手机背面靠近收银台NFC 通信区域，界面上的商品信息会自动逐条更新。通过使用+-按钮设置商品的数量，不需要商品可以在此清单中删除。以上过程如图\ref{fig:shopping-list} 所示。

              \item 确认购买后，可在结账界面输入用户名和密码，点击确认支付按钮后再次将手机背面靠近受理终端NFC通信区域内，即可完成付款。如图    \ref{fig:shopping-comfirm}所示。

              \item 在结算这个流程中，客户端可见余额变化，服务端会自动计算价格与交易信息，服务端数据库内会存储对应信息。如图\ref{fig:shopping-transaction-log}所示。
                  \begin{figure}[htbp]
                    \centering
                    \includegraphics[width=15cm]{img/shopping-transaction-log.png}\\
                    \caption{服务端数据库交易记录}
                    \label{fig:shopping-transaction-log}
                  \end{figure}

              \item 受理终端在整个过程中主要起中间媒介转发信息用。除此之外，移动客户端还要读取收银台身份标识，以确认所购买商品支付金额的去向。
            \end{enumerate}

            由以上结果可见，整个系统工作流程简洁精炼，但同时也需要各个组件与细节的配合，移动客户端可以不借助Internet完成整个移动支付的流程，商家仅需使用一个受理终端即可完成商品交易的全过程。



    \chapter{总结与展望}

        \thispagestyle{fancy}

        \section{总结}

            本设计从技术实现、应用便利与支付安全等角度全方面考虑并设计了第三方移动支付平台，包括移动客户端应用程序、受理终端应用程序及服务端Web应用程序，并以一普通购买者购买商品为例，演示了系统使用流程。

            本设计详细介绍了Hybrid模式与NFC技术。使用了Cordova框架构建移动客户端应用程序，Cordova框架核心之处在于其插件模式，能使得开发者通过自定义插件来扩展所需功能，有非常高的自由度。本设计通过自定义插件实现并封装NFC与摄像头相关功能。

            本设计在原有NFC协议栈之上，进一步封装传输层分组交换协议与应用层协议异步HTTP请求隧道协议，通过扩展协议的支持能方便地进行大尺寸数据的传输和NFC网络与Internet相融合，为应用开发提供了不少便利。

        \section{展望}

            通过对移动支付系统的设计与实现，也在过程中发现了许多值得深入和研究的地方，当然本文的设计还有很多需要完善的地方。

            如系统并发性与高负载问题，随着用户的增加，业务数据流越来越频繁，对系统请求负担也会越来越大，如何解决并发线程对系统的压力，优化系统性能是重点，也是作为商业软件的关键技术。

            又如安全性问题，这是移动支付平台的核心问题，也是用户最担心的问题，虽然采用先进成熟的非对称加密技术，但仍需全方面多角度做足安全措施，保证交易的安全性。

            系统的功能目前非常单一，本设计仅演示了最基础最核心的功能，相信以此为基础，再加之未来市场的发展和需求，本设计的移动支付平台还会扩展出更多功能。

            综上所述，要真正实现 NFC 技术在移动支付领域的应用还有很长的道路要走，还需要从各个方面来发展产业，最终形成完善的产业链。虽然随着 NFC 发展正式步入正轨，但整个产业链的发展仍然需要相关部门尽快制定各种标准，为 NFC 技术的移动支付铺平道路。相信已本文的移动支付设计方案为基础，再未来加以不断完善，不就的将来基于 NFC 技术的移动支付将很快出现在我们身边，成为人们的主流支付手段，第三方的移动支付系统发展也任重道远。


        % 结尾需要这个来提示即将终止CJK环境，否则编译出错。。。网上抄的
        \newpage

\end{CJK*}
\end{document}
